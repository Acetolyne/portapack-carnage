<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Portapack-Carnage: ARM7/9</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Portapack-Carnage
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Modules</a>  </div>
  <div class="headertitle">
<div class="title">ARM7/9<div class="ingroups"><a class="el" href="group__ports.html">Ports</a> &raquo; <a class="el" href="group__gcc.html">GCC Ports</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Collaboration diagram for ARM7/9:</div>
<div class="dyncontent">
<div class="center"><img src="group__ARM.png" border="0" usemap="#group____ARM" alt=""/></div>
<map name="group____ARM" id="group____ARM">
<area shape="rect" href="group__ARM__CONF.html" title=" " alt="" coords="273,5,437,31"/>
<area shape="rect" href="group__gcc.html" title="Ports for the GCC compiler or derivatives." alt="" coords="5,80,92,105"/>
<area shape="rect" title=" " alt="" coords="140,80,212,105"/>
<area shape="rect" href="group__ARM__SPECIFIC.html" title=" " alt="" coords="261,55,449,80"/>
<area shape="rect" href="group__ARM__STARTUP.html" title=" " alt="" coords="294,104,417,129"/>
<area shape="rect" href="group__ARM__CORE.html" title=" " alt="" coords="260,153,451,179"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Modules</h2></td></tr>
<tr class="memitem:group__ARM__CONF"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ARM__CONF.html">Configuration Options</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__ARM__CORE"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ARM__CORE.html">Core Port Implementation</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__ARM__STARTUP"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ARM__STARTUP.html">Startup Support</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__ARM__SPECIFIC"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ARM__SPECIFIC.html">Specific Implementations</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>ARM7/9 port for the GCC compiler.</p>
<h1><a class="anchor" id="ARM_INTRO"></a>
Introduction</h1>
<p>The ARM7/9-GCC port supports the ARM7/9 core in the following three modes:</p><ul>
<li><b>Pure ARM</b> mode, this is the preferred mode for code speed, this mode increases the memory footprint however. This mode is enabled when all the modules are compiled in ARM mode, see the Makefiles.</li>
<li><b>Pure THUMB</b> mode, this is the preferred mode for code size. In this mode the execution speed is slower than the ARM mode. This mode is enabled when all the modules are compiled in THUMB mode, see the Makefiles.</li>
<li><b>Interworking</b> mode, when in the system there are ARM modules mixed with THUMB modules then the interworking compiler option is enabled. This is usually the slowest mode and the code size is not as good as in pure THUMB mode.</li>
</ul>
<h1><a class="anchor" id="ARM_STATES"></a>
Mapping of the System States in the ARM7/9 port</h1>
<p>The ChibiOS/RT logical system states are mapped as follow in the ARM7/9 port:</p><ul>
<li><b>Init</b>. This state is represented by the startup code and the initialization code before <code><a class="el" href="group__system_gafe2c7de6567e98e487e009e81e3be10b.html#gafe2c7de6567e98e487e009e81e3be10b" title="ChibiOS/RT initialization.">chSysInit()</a></code> is executed. It has not a special hardware state associated, usually the CPU goes through several hardware states during the startup phase.</li>
<li><b>Normal</b>. This is the state the system has after executing <code><a class="el" href="group__system_gafe2c7de6567e98e487e009e81e3be10b.html#gafe2c7de6567e98e487e009e81e3be10b" title="ChibiOS/RT initialization.">chSysInit()</a></code>. In this state the CPU has both the interrupt sources (IRQ and FIQ) enabled and is running in ARM System Mode.</li>
<li><b>Suspended</b>. In this state the IRQ sources are disabled but the FIQ sources are served, the core is running in ARM System Mode.</li>
<li><b>Disabled</b>. Both the IRQ and FIQ sources are disabled, the core is running in ARM System Mode.</li>
<li><b>Sleep</b>. ARM7/9 cores does not have an explicit built-in low power mode but there are clock stop modes implemented in custom ways by the various silicon vendors. This state is implemented in each microcontroller support code in a different way, the core is running (or freezed...) in ARM System Mode.</li>
<li><b>S-Locked</b>. IRQ sources disabled, core running in ARM System Mode.</li>
<li><b>I-Locked</b>. IRQ sources disabled, core running in ARM IRQ Mode. Note that this state is not different from the SRI state in this port, the <code>chSysLockI()</code> and <code>chSysUnlockI()</code> APIs do nothing (still use them in order to formally change state because this may change).</li>
<li><b>Serving Regular Interrupt</b>. IRQ sources disabled, core running in ARM IRQ Mode. See also the I-Locked state.</li>
<li><b>Serving Fast Interrupt</b>. IRQ and FIQ sources disabled, core running in ARM FIQ Mode.</li>
<li><b>Serving Non-Maskable Interrupt</b>. There are no asynchronous NMI sources in ARM7/9 architecture but synchronous SVC, ABT and UND exception handlers can be seen as belonging to this category.</li>
<li><b>Halted</b>. Implemented as an infinite loop after disabling both IRQ and FIQ sources. The ARM state is whatever the processor was running when <code><a class="el" href="group__system_gad43b78f160a2c983792af3041cc4a536.html#gad43b78f160a2c983792af3041cc4a536" title="Halts the system.">chSysHalt()</a></code> was invoked.</li>
</ul>
<h1><a class="anchor" id="ARM_NOTES"></a>
The ARM7/9 port notes</h1>
<p>The ARM7/9 port is organized as follow:</p><ul>
<li>The <code><a class="el" href="group__ARMCMx__STARTUP.html#ga6288eba0f8e8ad3ab1544ad731eb7667" title="Application main() function.">main()</a></code> function is invoked in system mode.</li>
<li>Each thread has a private user/system stack, the system has a single interrupt stack where all the interrupts are processed.</li>
<li>The threads are started in system mode.</li>
<li>The threads code can run in system mode or user mode, however the code running in user mode cannot invoke the ChibiOS/RT APIs directly because privileged instructions are used inside.<br  />
 The kernel APIs can be eventually invoked by using a SWI entry point that handles the switch in system mode and the return in user mode.</li>
<li>Other modes are not preempt-able because the system code assumes the threads running in system mode. When running in supervisor or other modes make sure that the interrupts are globally disabled.</li>
<li>Interrupts nesting is not supported in the ARM7/9 port because their implementation, even if possible, is not really efficient in this architecture.</li>
<li>FIQ sources can preempt the kernel (by design) so it is not possible to invoke the kernel APIs from inside a FIQ handler. FIQ handlers are not affected by the kernel activity so there is not added jitter.</li>
</ul>
<h1><a class="anchor" id="ARM_IH"></a>
ARM7/9 Interrupt Handlers</h1>
<p>In the current implementation the ARM7/9 Interrupt handlers do not save function-saved registers so you need to make sure your code saves them or does not use them (this happens because in the ARM7/9 port all the OS interrupt handler functions are declared naked).<br  />
 Function-trashed registers (R0-R3, R12, LR, SR) are saved/restored by the system macros <code><a class="el" href="group__system_ga0d78c6e90e5f0a4eb52aaab37e45a494.html#ga0d78c6e90e5f0a4eb52aaab37e45a494" title="IRQ handler enter code.">CH_IRQ_PROLOGUE()</a></code> and <code><a class="el" href="group__system_ga864d6b8056d7d8f56322bbfcc8515d77.html#ga864d6b8056d7d8f56322bbfcc8515d77" title="IRQ handler exit code.">CH_IRQ_EPILOGUE()</a></code>.<br  />
 The easiest way to ensure this is to just invoke a normal function from within the interrupt handler, the function code will save all the required registers.<br  />
 Example: </p><div class="fragment"><div class="line"><a class="code" href="group__system_ga52426c607fac82b1e0ad975b367f95e9.html#ga52426c607fac82b1e0ad975b367f95e9">CH_IRQ_HANDLER</a>(irq_handler) {</div>
<div class="line">  <a class="code" href="group__system_ga0d78c6e90e5f0a4eb52aaab37e45a494.html#ga0d78c6e90e5f0a4eb52aaab37e45a494">CH_IRQ_PROLOGUE</a>();</div>
<div class="line"> </div>
<div class="line">  serve_interrupt();</div>
<div class="line"> </div>
<div class="line">  VICVectAddr = 0; <span class="comment">// This is LPC214x-specific.</span></div>
<div class="line">  <a class="code" href="group__system_ga864d6b8056d7d8f56322bbfcc8515d77.html#ga864d6b8056d7d8f56322bbfcc8515d77">CH_IRQ_EPILOGUE</a>();</div>
<div class="line">}</div>
</div><!-- fragment --><p> This is not a bug but an implementation choice, this solution allows to have interrupt handlers compiled in thumb mode without have to use an interworking mode (the mode switch is hidden in the macros), this greatly improves code efficiency and size. You can look at the serial driver for real examples of interrupt handlers.<br  />
 It is important that the serve_interrupt() interrupt function is not inlined by the compiler into the ISR or the code could still modify the unsaved registers, this can be accomplished using GCC by adding the attribute "noinline" to the function: </p><div class="fragment"><div class="line"><span class="preprocessor">#if defined(__GNUC__)</span></div>
<div class="line"><a class="code" href="group__usb__cdc__defines_ga292567ae038e2672b895f5162aaa0959.html#ga292567ae038e2672b895f5162aaa0959">__attribute__</a>((noinline))</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> serve_interrupt(<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
</div><!-- fragment --><p> Note that several commercial compilers support a GNU-like functions attribute mechanism.<br  />
 Alternative ways are to use an appropriate pragma directive or disable inlining optimizations in the modules containing the interrupt handlers. </p>
</div><!-- contents -->
<div class="ttc" id="agroup__system_ga864d6b8056d7d8f56322bbfcc8515d77_html_ga864d6b8056d7d8f56322bbfcc8515d77"><div class="ttname"><a href="group__system_ga864d6b8056d7d8f56322bbfcc8515d77.html#ga864d6b8056d7d8f56322bbfcc8515d77">CH_IRQ_EPILOGUE</a></div><div class="ttdeci">#define CH_IRQ_EPILOGUE()</div><div class="ttdoc">IRQ handler exit code.</div><div class="ttdef"><b>Definition:</b> chsys.h:215</div></div>
<div class="ttc" id="agroup__system_ga52426c607fac82b1e0ad975b367f95e9_html_ga52426c607fac82b1e0ad975b367f95e9"><div class="ttname"><a href="group__system_ga52426c607fac82b1e0ad975b367f95e9.html#ga52426c607fac82b1e0ad975b367f95e9">CH_IRQ_HANDLER</a></div><div class="ttdeci">#define CH_IRQ_HANDLER(id)</div><div class="ttdoc">Standard normal IRQ handler declaration.</div><div class="ttdef"><b>Definition:</b> chsys.h:226</div></div>
<div class="ttc" id="agroup__usb__cdc__defines_ga292567ae038e2672b895f5162aaa0959_html_ga292567ae038e2672b895f5162aaa0959"><div class="ttname"><a href="group__usb__cdc__defines_ga292567ae038e2672b895f5162aaa0959.html#ga292567ae038e2672b895f5162aaa0959">__attribute__</a></div><div class="ttdeci">uint64_t stkalign_t __attribute__((aligned(8)))</div><div class="ttdoc">Performs a context switch between two threads.</div><div class="ttdef"><b>Definition:</b> chcore_v6m.h:173</div></div>
<div class="ttc" id="agroup__system_ga0d78c6e90e5f0a4eb52aaab37e45a494_html_ga0d78c6e90e5f0a4eb52aaab37e45a494"><div class="ttname"><a href="group__system_ga0d78c6e90e5f0a4eb52aaab37e45a494.html#ga0d78c6e90e5f0a4eb52aaab37e45a494">CH_IRQ_PROLOGUE</a></div><div class="ttdeci">#define CH_IRQ_PROLOGUE()</div><div class="ttdoc">IRQ handler enter code.</div><div class="ttdef"><b>Definition:</b> chsys.h:203</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
